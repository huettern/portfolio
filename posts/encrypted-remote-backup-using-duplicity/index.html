<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#00ff00">
<meta name="description" content="Noah Hütter&#39;s Academic Achievements and a Selection of Electronics and Embedded themed Blog Posts focusing on FPGA, Linux and other fast stuff.">
<meta property="og:description" content="Noah Hütter&#39;s Academic Achievements and a Selection of Electronics and Embedded themed Blog Posts focusing on FPGA, Linux and other fast stuff.">
<meta name="twitter:description" content="Noah Hütter&#39;s Academic Achievements and a Selection of Electronics and Embedded themed Blog Posts focusing on FPGA, Linux and other fast stuff.">
<meta property="og:image" content="https://xn--htter-kva.ch/img/portrait_800.png">
<meta name="twitter:image" content="https://xn--htter-kva.ch/img/portrait_800.png">
<meta name="keywords" content="Noah, Hütter, Huetter, Noah Hütter, Noah Huetter, Electronics, Electrical Engineer, ETH Zurich, ETH, FHNW, FPGA, Linux, Zynq, Embedded">

<title>Encrypted Remote Backup using duplicity</title>

<link rel="icon" href="https://xn--htter-kva.ch/img/tux_pitaya_round-min-crop.png" type="image/x-icon">
<link rel="shortcut icon" href="https://xn--htter-kva.ch/img/tux_pitaya_round-min-crop.png" type="image/x-icon">



<link rel="stylesheet" href="https://xn--htter-kva.ch/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="
sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
<link rel="stylesheet" href="https://xn--htter-kva.ch/css/final.css" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,700">



<script src="https://xn--htter-kva.ch/js/jquery.min.js"></script>
<script src="https://xn--htter-kva.ch/js/bootstrap.min.js"></script>
<script src="https://xn--htter-kva.ch/js/main.js"></script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-40883435-8', 'auto');
	
	ga('send', 'pageview');
}
</script>




    </head>
    <body>
        <a id="bttbutton" class="bg-dark"></a>
        <div class="progressCounter"></div>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark ">
  <a class="navbar-brand" href="/">hütter.ch</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">

    <ul class="navbar-nav mr-auto">   

    </ul>

    <ul class="navbar-nav">      
        

        
        
          
            <li class="nav-item">
              <a class="nav-link" href="/posts/">Blog posts</a>
            </li>
          
        

    </ul>
  </div>
</nav>








        
            <div class="jumbotron" style="background: url(https://xn--htter-kva.ch/img/jumbos/dupl-header.png) no-repeat center center;">
            </div>
        

        <section>
            <div class="content-post">
            <h1>Encrypted Remote Backup using duplicity</h1>
            <p style="text-align:center;margin-top: 0.5em;">
                <strong>Posted on</strong> 15 Jul 2019 
                <strong>By</strong> Noah Hütter 
            </p>

            <hr>
            <h2>Description</h2>
            <p>Encrypted remote backup of a Synology NAS using Raspberry Pi and duplicity.</p>

            <h2>Table of Contents</h2>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#solution">Solution</a></li>
    <li><a href="#how-to">How-To</a>
      <ul>
        <li><a href="#outpost">Outpost</a></li>
        <li><a href="#nas">NAS</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#notes-on-gpg">Notes on GPG</a></li>
    <li><a href="#sources">Sources</a></li>
  </ul>
</nav>
            <h2 id="introduction">Introduction</h2>
<p>My Data is currently stored on a 5 bay Synology NAS running a SHR RAID. All data is periodically backed up to a external hard drive using HyperBackup. This way my data is safe from a RAID failure. BUT what if the data gets mechanically destroyed or a virus encrypts all data on the NAS? An off-site backup solution must be found.</p>
<h2 id="requirements">Requirements</h2>
<ul>
<li>Off-site backup at low to no cost therefore cloud services are expelled</li>
<li>Data transfer over SSH because security</li>
<li>Data encryption! I don&rsquo;t want my data off-site and accessible to everyone</li>
<li>SSH enabled on the Synology NAS</li>
<li>A domain or IP pointing to your Synology NAS</li>
</ul>
<h2 id="solution">Solution</h2>
<p>A Raspberry Pi that I had laying around doing nothing and an external USB hard drive for storage is located at a friends home. Power consumption is maximum 15W (5W raspberry + 10W HDD). The Pi forwards a port for SSH using UPnP and announces its outside IP to my NAS every minute. On my NAS a periodical task runs the backup using duplicity.</p>
<h2 id="how-to">How-To</h2>
<p>Split into two parts for setting up the Raspberry PI and the NAS.</p>
<h3 id="outpost">Outpost</h3>
<ul>
<li>Create announce script to publish the outposts public IP to the NAS</li>
<li>Enable SSH from the outpost to the NAS and vice-versa using key authentication</li>
</ul>
<h4 id="1-announce-script">1. Announce Script</h4>
<p>The Raspberry Pi at a friends is called Outpost. Set-Up a minimal Raspbian install and enable SSH to get started. Install upnpc using this command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt-get install miniupnpc
</code></pre></div><p>Copy the following script into the pi user&rsquo;s home directory and Change the HOST and HOST_PORT variables to the domain name or external IP of your NAS and its SSH port.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#/bin/bash</span>

<span style="color:#75715e"># Outside port to be openned for incomming ssh connections</span>
PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">37326</span>
<span style="color:#75715e"># Host Name and Port of the announce destination using SSH</span>
HOST<span style="color:#f92672">=</span>yourdomainorstaticip.com
HOST_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">22</span> <span style="color:#75715e"># forwarded SSH port</span>

curl -s http://whatismyip.akamai.com/ | ssh outpost@$HOST -p$HOST_PORT <span style="color:#e6db74">&#34;cat &gt; ~/outpost_ip.txt; echo &#34;</span>:$PORT<span style="color:#e6db74">&#34; &gt;&gt; ~/outpost_ip.txt&#34;</span>
<span style="color:#75715e"># Make sure port is forwarded</span>
upnpc -a <span style="color:#e6db74">`</span>ifconfig | sed -En <span style="color:#e6db74">&#39;s/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\.){3}[0-9]*).*/\2/p&#39;</span><span style="color:#e6db74">`</span> <span style="color:#ae81ff">22</span> $PORT TCP
</code></pre></div><p>This script will get the Pi&rsquo;s public IP and put it in a file in the user outpost home directory of the NAS. Furthermore it opens the port and redirects it to the Pi&rsquo;s SSH port.</p>
<h4 id="2-ssh-login-without-password">2. SSH Login without password</h4>
<p>Now create a user outpost on your NAS and enable SSH for that user by adding a triggered task on boot to change the login shell. Make sure the task is executed by root.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/usr/bin/awk -i inplace -F: <span style="color:#e6db74">&#39;BEGIN{OFS=&#34;:&#34;}/^outpost\:/{gsub(/.*/,&#34;/bin/sh&#34;,$7)}1&#39;</span> /etc/passwd
</code></pre></div><p>By default only the users in the administrator group have SSH login permissions. This line will alter the /etc/passwd file to enable SSH login for the user outpost.</p>
<p><em>Make sure you have no typos and try it out on a copy of /etc/passwd. If this script screws up your passwd file you won&rsquo;t be able to log into your NAS anymore!</em></p>
<p>Next we create ssh keys to log into your NAS from the outpost without using a password. On the outpost run changing HOST and PORT to your NAS hostname and SSH port.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh-keygen
ssh-copy-id outpost@HOST -pPORT
</code></pre></div><p>This will allow the outpost to log into your NAS without password. Test it by opening a SSH connection:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh outpost@HOST -pPORT
</code></pre></div><p>Now it&rsquo;s time to test the announce script. Enable execution permission and launch the script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x announce.sh
./announce.sh
</code></pre></div><p>You should now have a file called outpost_ip.txt in the home directory of the user outpost on the NAS holding its public IP and the forwarded SSH port. On your NAS open a test connection to the outpost using:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">HOST<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>cat /var/services/homes/outpost/outpost_ip.txt<span style="color:#e6db74">`</span>
USER<span style="color:#f92672">=</span>pi
ssh $USER@<span style="color:#e6db74">${</span>HOST/:/<span style="color:#e6db74">&#34; -p&#34;</span><span style="color:#e6db74">}</span>
</code></pre></div><p>For the backup we need to log in to the outpost using SSH. Therefore we create SSH keys on the NAS and copy them to the outpost. Sadly Synology doesn&rsquo;t support the ssh-copy-id command so we have to do this manually. On your NAS run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh-keygen
HOST<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>cat /var/services/homes/outpost/outpost_ip.txt<span style="color:#e6db74">`</span>
USER<span style="color:#f92672">=</span>pi
ssh $USER@<span style="color:#e6db74">${</span>HOST/:/<span style="color:#e6db74">&#34; -p&#34;</span><span style="color:#e6db74">}</span> <span style="color:#e6db74">&#34;mkdir -p ~/.ssh; touch ~/.ssh/authorized_keys&#34;</span>
cat ~/.ssh/id_rsa.pub | ssh $USER@<span style="color:#e6db74">${</span>HOST/:/<span style="color:#e6db74">&#34; -p&#34;</span><span style="color:#e6db74">}</span> <span style="color:#e6db74">&#34;cat &gt; ~/.ssh/authorized_keys&#34;</span>
</code></pre></div><p>This should grant you access to the outpost without password. Make sure this works by opening a SSH connection using:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">HOST<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>cat /var/services/homes/outpost/outpost_ip.txt<span style="color:#e6db74">`</span>
USER<span style="color:#f92672">=</span>pi
ssh $USER@<span style="color:#e6db74">${</span>HOST/:/<span style="color:#e6db74">&#34; -p&#34;</span><span style="color:#e6db74">}</span>
</code></pre></div><h4 id="3-add-cronjob">3. Add cronjob</h4>
<p>To ensure the announce script is executed periodically add a cronjob. This will run the announce script every minute, ensuring that we always have the current IP address of the outpost on the NAS.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">crontab -e
* * * * * ./announce.sh
</code></pre></div><p>The last step is to mount the USB hard drive. Follow the guide <a href="https://www.raspberrypi.org/documentation/configuration/external-storage.md">here</a>.</p>
<p>The outpost is now set up and ready to take SSH connections from the NAS.</p>
<h3 id="nas">NAS</h3>
<p>The hard part is now done. On the NAS side we have to</p>
<ul>
<li>install the duplicity program</li>
<li>generate encryption keys</li>
<li>add a script to run the backup</li>
<li>backup the encryption key</li>
</ul>
<h4 id="1-install-package">1. Install package</h4>
<p>Add the following address to the Synology package source in the Package Manager and enable beta releases, also in Package Manager Settings:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">http://packages.synocommunity.com/
</code></pre></div><p><img src="Screen-Shot-2018-02-08-at-19.45.48.png" alt="Enable Beta releses"></p>
<p><img src="Screen-Shot-2018-02-08-at-19.48.08.png" alt="Add the Synocommunity package source"></p>
<p>Now install the duplicity package.</p>
<h4 id="2-setup-keys">2. Setup keys</h4>
<p>The duplicity package comes with a fixed version of gpg2. Create an alias to access this binary and change some settings to make it work (source <a href="https://github.com/SynoCommunity/spksrc/wiki/Duplicity">here</a>)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#34;alias gpg2syno=&#39;/usr/local/gnupg/bin/gpg2&#39;&#34;</span> &gt;&gt; ~/.bashrc
alias gpg2syno<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/usr/local/gnupg/bin/gpg2&#39;</span>
mkdir -p ~/.gnupg
echo <span style="color:#e6db74">&#34;allow-loopback-pinentry&#34;</span> &gt; ~/.gnupg/gpg-agent.conf
</code></pre></div><p>Now we generate a GPG key par to encrypt our data. Run the following command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gpg2syno --gen-key
<span style="color:#75715e"># List keys</span>
gpg2syno --list-keys
</code></pre></div><p>Note the key ID, it will be needed later:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pub   rsa2048/3387FFED 2018-02-08
uid       <span style="color:#f92672">[</span>ultimate<span style="color:#f92672">]</span> Fox &lt;fox@forrest.com&gt;
sub   rsa2048/81398558 2018-02-08
<span style="color:#75715e"># Key ID = 3387FFED</span>
</code></pre></div><h4 id="3-create-backup-scripts">3. Create backup scripts</h4>
<p>Now we create the backup and restore scripts. I put them into a folder</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p ~/scripts/outpost/
</code></pre></div><p>This is the script for backup <code>outpost_backup.sh</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># GPG Key to use for data encryption</span>
KEY_ID<span style="color:#f92672">=</span>3486F4FD

<span style="color:#75715e"># Host</span>
HOST<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>cat /var/services/homes/outpost/outpost_ip.txt<span style="color:#e6db74">`</span>
REMOTE_USER<span style="color:#f92672">=</span>pi

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $# -ne <span style="color:#ae81ff">2</span> <span style="color:#f92672">]</span>
  <span style="color:#66d9ef">then</span>
  echo <span style="color:#e6db74">&#34;Not enough input arguments&#34;</span>
  echo <span style="color:#e6db74">&#34;Usage: ./outpost_backup.sh SOURCE DESTINATION&#34;</span>
  exit -1
<span style="color:#66d9ef">fi</span>

export USER<span style="color:#f92672">=</span>noah
echo Command: $0 $1 $2
echo User: $USER
echo Hostname: $HOSTNAME

<span style="color:#75715e"># Fetch input arguments</span>
SOURCE<span style="color:#f92672">=</span>$1
NAME<span style="color:#f92672">=</span>$2
<span style="color:#75715e"># Set destination, relative to pi home</span>
DESTINATION<span style="color:#f92672">=</span>storage/new/$HOSTNAME/$NAME

<span style="color:#75715e"># Other settings</span>
ARCHIVE_DIR<span style="color:#f92672">=</span>/var/services/homes/$USER/scripts/outpost/archive/
TEMP_DIR<span style="color:#f92672">=</span>/var/services/homes/$USER/scripts/outpost/tmp/
LOG_FILE<span style="color:#f92672">=</span>/var/services/homes/noah/scripts/outpost/log/backup_<span style="color:#e6db74">`</span>date +%Y_%m_%d_%H:%M<span style="color:#e6db74">`</span>

<span style="color:#75715e"># Backup command</span>
duplicity_cmd<span style="color:#f92672">(){</span>
  ssh $REMOTE_USER@<span style="color:#e6db74">${</span>HOST/:/<span style="color:#e6db74">&#34; -p&#34;</span><span style="color:#e6db74">}</span> <span style="color:#e6db74">&#34;mkdir -p </span>$DESTINATION<span style="color:#e6db74">&#34;</span>
  duplicity <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --asynchronous-upload <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --verbosity <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --gpg-binary<span style="color:#f92672">=</span>/usr/local/gnupg/bin/gpg2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --archive-dir<span style="color:#f92672">=</span>$ARCHIVE_DIR <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --tempdir<span style="color:#f92672">=</span>$TEMP_DIR <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --encrypt-key $KEY_ID <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --exclude <span style="color:#e6db74">&#34;**files_trashbin&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --exclude <span style="color:#e6db74">&#34;**#recycle&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --log-file $LOG_FILE<span style="color:#ae81ff">\_</span>$NAME.log <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ssh-options<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-oStrictHostKeyChecking=no&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    $SOURCE rsync://$REMOTE_USER@$HOST/$DESTINATION
<span style="color:#f92672">}</span>
duplicity_status<span style="color:#f92672">(){</span>
  duplicity collection-status <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --gpg-binary<span style="color:#f92672">=</span>/usr/local/gnupg/bin/gpg2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --archive-dir<span style="color:#f92672">=</span>$ARCHIVE_DIR <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --tempdir<span style="color:#f92672">=</span>$TEMP_DIR <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --encrypt-key $KEY_ID <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --log-file $LOG_FILE<span style="color:#ae81ff">\_</span>$NAME_status.log <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ssh-options<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-oStrictHostKeyChecking=no&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    rsync://$REMOTE_USER@$HOST/$DESTINATION
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Run backup</span>
duplicity_cmd
duplicity_status

</code></pre></div><p>The most important line is the last line launching the duplicity program. The parameters are</p>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>&ndash;asynchronous-upload</td>
<td>Simultaneously compress and upload data</td>
</tr>
<tr>
<td>&ndash;verbosity 5</td>
<td>talk to me</td>
</tr>
<tr>
<td>&ndash;gpg-binary=/usr/local/gnupg/bin/gpg2</td>
<td>link to the gpg2 library</td>
</tr>
<tr>
<td>&ndash;archive-dir=$ARCHIVE_DIR</td>
<td>archive directory. This is specified to not use a folder on / because storage is limited there</td>
</tr>
<tr>
<td>&ndash;tempdir=$TEMP_DIR</td>
<td>same reason as &ndash;archive-dir</td>
</tr>
<tr>
<td>&ndash;encrypt-key $KEY_ID</td>
<td>your encryption key to use</td>
</tr>
<tr>
<td>$SOURCE</td>
<td>the source folder</td>
</tr>
<tr>
<td>rsync://$USER@$HOST/$DESTINATION</td>
<td>destination using rsync</td>
</tr>
</tbody>
</table>
<p>And this is the script for restoring:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $# -ne <span style="color:#ae81ff">3</span> <span style="color:#f92672">]</span>
  <span style="color:#66d9ef">then</span>
  echo <span style="color:#e6db74">&#34;Not enough input arguments&#34;</span>
  echo <span style="color:#e6db74">&#34;Usage: ./outpost_restore.sh HOSTNAME_GIVEN NAME RESTORE_DESTINATION&#34;</span>
  exit -1
<span style="color:#66d9ef">fi</span>

<span style="color:#75715e"># GPG Key to use for data encryption</span>
KEY_ID<span style="color:#f92672">=</span>3486F4FD

<span style="color:#75715e"># Host</span>
HOST<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>cat /var/services/homes/outpost/outpost_ip.txt<span style="color:#e6db74">`</span>
REMOTE_USER<span style="color:#f92672">=</span>pi

<span style="color:#75715e"># Fetch arguments</span>
HOSTNAME_GIVEN<span style="color:#f92672">=</span>$1
NAME<span style="color:#f92672">=</span>$2
RECOVER_DST<span style="color:#f92672">=</span>$3

<span style="color:#75715e"># Set destination, relative to pi home</span>
REMOTE<span style="color:#f92672">=</span>storage/new/$HOSTNAME_GIVEN/$NAME

<span style="color:#75715e"># Restore command</span>
duplicity_cmd<span style="color:#f92672">(){</span>
  duplicity restore <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --verbosity <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --progress <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --gpg-binary<span style="color:#f92672">=</span>/usr/local/gnupg/bin/gpg2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --encrypt-key $KEY_ID <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  rsync://$REMOTE_USER@$HOST/$REMOTE $RECOVER_DST
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Recover command</span>
duplicity_cmd
</code></pre></div><p>Put them in <code>~/scripts/outpost/</code>.</p>
<h4 id="4-run-test-backup">4. Run test backup</h4>
<p>To test the scripts we create a folder containing some files and launch the backup task.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd scripts/outpost/
mkdir -p test
touch test/file<span style="color:#f92672">{</span>0..9<span style="color:#f92672">}</span>
chmod +x outpost_backup.sh
chmod +x outpost_restore.sh
./outpost_backup.sh test/ test
</code></pre></div><p>Your data should now be on the outpost encrypted and compressed! duplicity will run incremental backups if you launch it again, meaning it checks for backup integrity and only transfers changed data.</p>
<p>To check if you can restore the data run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir restore
./outpost_restore.sh test test/
</code></pre></div><h4 id="5-create-backup-task">5. Create backup task</h4>
<p>The last step is to create a scheduled task with the correct arguments. It might look something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/bin/su - noah -c <span style="color:#e6db74">&#34;/var/services/homes/noah/scripts/outpost/outpost_backup.sh /volume2/private/owncloud/clouddata/ clouddata 2&gt;&amp;1 | tee /var/services/homes/noah/scripts/outpost/log/backup_`date +%Y_%m_%d_%H:%M`.log&#34;</span>
</code></pre></div><p>Change the user to the one you created the scripts with and the data directories to the ones you want to backup.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The first backup will take lots of time (50GB in about 14h). But after that the backup should take only some minutes. The backup is encrypted so you could install the outpost everywhere you like.</p>
<h2 id="notes-on-gpg">Notes on GPG</h2>
<p>Some commands for GPG.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">alias gpg2syno<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/usr/local/gnupg/bin/gpg2&#39;</span>

<span style="color:#75715e"># List keys</span>
gpg2syno --list-keys

<span style="color:#75715e"># Export private key</span>
KEY_ID<span style="color:#f92672">=</span><span style="color:#ae81ff">12345678</span>
gpg2syno -a --export-secret-keys $KEY_ID &gt; secret-gpg.key

<span style="color:#75715e"># Export public key</span>
gpg2syno -a --export $KEY_ID &gt; public-gpg.key

<span style="color:#75715e"># Import pirvate key (includes public key)</span>
gpg2syno --import secret-gpg.key
</code></pre></div><h2 id="sources">Sources</h2>
<p><!-- raw HTML omitted --><a href="https://github.com/SynoCommunity/spksrc/wiki/Duplicity">https://github.com/SynoCommunity/spksrc/wiki/Duplicity</a><!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted --><a href="https://splone.com/blog/2015/7/13/encrypted-backups-using-rsync-and-duplicity-with-gpg-and-ssh-on-linux-bsd/">https://splone.com/blog/2015/7/13/encrypted-backups-using-rsync-and-duplicity-with-gpg-and-ssh-on-linux-bsd/</a><!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted --><a href="https://ubuntuforums.org/showthread.php?t=2213815">https://ubuntuforums.org/showthread.php?t=2213815</a><!-- raw HTML omitted --></p>

            </div>

            <div class="content-post">
                <hr>
                <script src="https://utteranc.es/client.js"
                        repo="noah95/portfolio"
                        issue-term="title"
                        label="comments"
                        theme="github-light"
                        crossorigin="anonymous"
                        async>
                </script>
            </div>

        </section>

        
        <footer>
    
    
</footer>
        
    </body>
</html>
